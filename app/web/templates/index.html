<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>{{ brand.app_name }}</title>
    <link rel="icon" type="image/x-icon" href="{{ url_for('static', path='/favicon.ico') }}?v=2" />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;700&family=IBM+Plex+Sans:wght@400;500;600&display=swap"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="{{ url_for('static', path='/styles.css') }}?v=3" />
    <style>
      :root {
        --brand-primary: {{ brand.brand_primary }};
        --brand-secondary: {{ brand.brand_secondary }};
        --brand-ink: {{ brand.brand_ink }};
      }
    </style>
  </head>
  <body>
    <main class="shell">
      <section class="panel hero">
        <p class="eyebrow">CSV Export Workflow</p>
        <h1>{{ brand.app_name }}</h1>
        <p>{{ brand.app_tagline }}</p>
      </section>

      <section class="panel grid">
        <form class="import-form" method="post" action="/export.csv">
          {% set show_squarespace_fields = form.target_platform == "squarespace" %}

          <label for="product_url">Product URL</label>
          <input
            id="product_url"
            name="product_url"
            type="url"
            placeholder="https://store.com/products/example"
            value="{{ form.product_url }}"
            required
          />

          <label for="target_platform">Target Platform</label>
          <div class="select-wrap">
            <select id="target_platform" name="target_platform" required>
              <option value="shopify" {% if form.target_platform == "shopify" %}selected{% endif %}>Shopify</option>
              <option value="bigcommerce" {% if form.target_platform == "bigcommerce" %}selected{% endif %}>BigCommerce</option>
              <option value="wix" {% if form.target_platform == "wix" %}selected{% endif %}>Wix</option>
              <option value="squarespace" {% if form.target_platform == "squarespace" %}selected{% endif %}>Squarespace</option>
              <option value="woocommerce" {% if form.target_platform == "woocommerce" %}selected{% endif %}>WooCommerce</option>
            </select>
          </div>

          {% set selected_weight_unit = form.weight_unit if form.weight_unit else weight_unit_defaults[form.target_platform] %}
          <label for="weight_unit">Weight Unit</label>
          <div class="select-wrap">
            <select id="weight_unit" name="weight_unit" required>
              {% for unit in weight_unit_allowlist[form.target_platform] %}
              <option value="{{ unit }}" {% if selected_weight_unit == unit %}selected{% endif %}>{{ unit|upper }}</option>
              {% endfor %}
            </select>
          </div>

          <div
            id="bigcommerce-fields"
            class="conditional-fields{% if form.target_platform != "bigcommerce" %} is-hidden{% endif %}"
            aria-hidden="{% if form.target_platform == "bigcommerce" %}false{% else %}true{% endif %}"
          >
            <label for="bigcommerce_csv_format">BigCommerce CSV Format</label>
            <div class="select-wrap">
              <select
                id="bigcommerce_csv_format"
                name="bigcommerce_csv_format"
                {% if form.target_platform != "bigcommerce" %}disabled{% endif %}
              >
                <option value="modern" {% if form.bigcommerce_csv_format == "modern" %}selected{% endif %}>Modern</option>
                <option value="legacy" {% if form.bigcommerce_csv_format == "legacy" %}selected{% endif %}>Legacy</option>
              </select>
            </div>
          </div>

          <div
            id="squarespace-fields"
            class="conditional-fields{% if not show_squarespace_fields %} is-hidden{% endif %}"
            aria-hidden="{% if show_squarespace_fields %}false{% else %}true{% endif %}"
          >
            <label for="squarespace_product_page">Squarespace Product Page</label>
            <input
              id="squarespace_product_page"
              name="squarespace_product_page"
              type="text"
              placeholder="shop"
              value="{{ form.squarespace_product_page }}"
              {% if not show_squarespace_fields %}disabled{% endif %}
            />

            <label for="squarespace_product_url">Squarespace Product URL</label>
            <input
              id="squarespace_product_url"
              name="squarespace_product_url"
              type="text"
              placeholder="lemons"
              value="{{ form.squarespace_product_url }}"
              {% if not show_squarespace_fields %}disabled{% endif %}
            />
          </div>

          <button type="submit">Export CSV</button>
        </form>

        <aside class="info">
          <h2>Try URLs</h2>
          <ul>
            {% for example in examples %}
            <li><code>{{ example }}</code></li>
            {% endfor %}
          </ul>
          <p class="api-note">API endpoints: <code>POST /api/v1/export/{platform}.csv</code></p>
        </aside>
      </section>

      <section class="panel grid">
        <form class="import-form" method="post" action="/import.csv" enctype="multipart/form-data">
          <label for="source_platform">Source CSV Platform</label>
          <div class="select-wrap">
            <select id="source_platform" name="source_platform" required>
              <option value="shopify" {% if csv_form.source_platform == "shopify" %}selected{% endif %}>Shopify</option>
              <option value="bigcommerce" {% if csv_form.source_platform == "bigcommerce" %}selected{% endif %}>BigCommerce</option>
              <option value="wix" {% if csv_form.source_platform == "wix" %}selected{% endif %}>Wix</option>
              <option value="squarespace" {% if csv_form.source_platform == "squarespace" %}selected{% endif %}>Squarespace</option>
              <option value="woocommerce" {% if csv_form.source_platform == "woocommerce" %}selected{% endif %}>WooCommerce</option>
            </select>
          </div>

          <div
            id="source-weight-fields"
            class="conditional-fields{% if csv_form.source_platform not in source_weight_unit_required_platforms %} is-hidden{% endif %}"
            aria-hidden="{% if csv_form.source_platform in source_weight_unit_required_platforms %}false{% else %}true{% endif %}"
          >
            <label for="source_weight_unit">Source Weight Unit</label>
            <div class="select-wrap">
              <select
                id="source_weight_unit"
                name="source_weight_unit"
                {% if csv_form.source_platform not in source_weight_unit_required_platforms %}disabled{% endif %}
              >
                {% for unit in source_weight_unit_allowlist %}
                <option value="{{ unit }}" {% if csv_form.source_weight_unit == unit %}selected{% endif %}>{{ unit|upper }}</option>
                {% endfor %}
              </select>
            </div>
          </div>

          <label for="source_csv_file">CSV File</label>
          <input id="source_csv_file" name="file" type="file" accept=".csv,text/csv" required />

          <button type="submit">Import CSV</button>
        </form>

        <aside class="info">
          <h2>CSV Import</h2>
          <p class="api-note">API endpoint: <code>POST /api/v1/import/csv</code></p>
          <p class="api-note">Upload limit: <code>5 MB</code></p>
        </aside>
      </section>

      {% if preview_product_json %}
      <section class="panel">
        <h2>CSV Import Preview</h2>
        <details class="preview-disclosure">
          <summary>Show Preview JSON</summary>
          <pre class="preview-json"><code>{{ preview_product_json }}</code></pre>
        </details>
      </section>

      <section class="panel grid">
        <form class="import-form" method="post" action="/export-from-product.csv">
          <input type="hidden" name="product_json_b64" value="{{ preview_product_json_b64 }}" />

          <label for="preview_target_platform">Target Platform</label>
          <div class="select-wrap">
            <select id="preview_target_platform" name="target_platform" required>
              <option value="shopify">Shopify</option>
              <option value="bigcommerce">BigCommerce</option>
              <option value="wix">Wix</option>
              <option value="squarespace">Squarespace</option>
              <option value="woocommerce">WooCommerce</option>
            </select>
          </div>

          <label for="preview_weight_unit">Weight Unit</label>
          <div class="select-wrap">
            <select id="preview_weight_unit" name="weight_unit" required></select>
          </div>

          <div id="preview-bigcommerce-fields" class="conditional-fields is-hidden" aria-hidden="true">
            <label for="preview_bigcommerce_csv_format">BigCommerce CSV Format</label>
            <div class="select-wrap">
              <select id="preview_bigcommerce_csv_format" name="bigcommerce_csv_format" disabled>
                <option value="modern">Modern</option>
                <option value="legacy">Legacy</option>
              </select>
            </div>
          </div>

          <div id="preview-squarespace-fields" class="conditional-fields is-hidden" aria-hidden="true">
            <label for="preview_squarespace_product_page">Squarespace Product Page</label>
            <input id="preview_squarespace_product_page" name="squarespace_product_page" type="text" placeholder="shop" disabled />
            <label for="preview_squarespace_product_url">Squarespace Product URL</label>
            <input id="preview_squarespace_product_url" name="squarespace_product_url" type="text" placeholder="lemons" disabled />
          </div>

          <button type="submit">Export Preview as CSV</button>
        </form>
      </section>
      {% endif %}

      {% if error %}
      <section class="panel error">
        <h2>Export Error</h2>
        <p>{{ error }}</p>
      </section>
      {% endif %}
      {% if csv_error %}
      <section class="panel error">
        <h2>CSV Import Error</h2>
        <p>{{ csv_error }}</p>
      </section>
      {% endif %}
    </main>
    <script>
      (() => {
        const targetPlatform = document.getElementById("target_platform");
        const weightUnit = document.getElementById("weight_unit");
        const bigcommerceFields = document.getElementById("bigcommerce-fields");
        const squarespaceFields = document.getElementById("squarespace-fields");
        const sourcePlatform = document.getElementById("source_platform");
        const sourceWeightFields = document.getElementById("source-weight-fields");
        const sourceWeightUnit = document.getElementById("source_weight_unit");
        const previewTargetPlatform = document.getElementById("preview_target_platform");
        const previewWeightUnit = document.getElementById("preview_weight_unit");
        const previewBigcommerceFields = document.getElementById("preview-bigcommerce-fields");
        const previewSquarespaceFields = document.getElementById("preview-squarespace-fields");
        if (!targetPlatform || !weightUnit || !squarespaceFields || !bigcommerceFields) {
          return;
        }
        const weightUnitAllowlist = {{ weight_unit_allowlist | tojson }};
        const weightUnitDefaults = {{ weight_unit_defaults | tojson }};

        const bigcommerceInputs = bigcommerceFields.querySelectorAll("select, input");
        const squarespaceInputs = squarespaceFields.querySelectorAll("input");
        const sourceWeightRequiredPlatforms = new Set({{ source_weight_unit_required_platforms | tojson }});
        const previewBigcommerceInputs = previewBigcommerceFields
          ? previewBigcommerceFields.querySelectorAll("select, input")
          : [];
        const previewSquarespaceInputs = previewSquarespaceFields
          ? previewSquarespaceFields.querySelectorAll("input")
          : [];

        const syncConditionalFields = () => {
          const currentWeightUnit = weightUnit.value;
          const allowedWeightUnits = weightUnitAllowlist[targetPlatform.value] || [];
          const defaultWeightUnit = weightUnitDefaults[targetPlatform.value] || allowedWeightUnits[0] || "kg";
          const selectedWeightUnit = allowedWeightUnits.includes(currentWeightUnit)
            ? currentWeightUnit
            : defaultWeightUnit;
          weightUnit.innerHTML = "";
          allowedWeightUnits.forEach((unit) => {
            const option = document.createElement("option");
            option.value = unit;
            option.textContent = unit.toUpperCase();
            if (unit === selectedWeightUnit) {
              option.selected = true;
            }
            weightUnit.appendChild(option);
          });

          const showBigCommerceFields = targetPlatform.value === "bigcommerce";
          bigcommerceFields.classList.toggle("is-hidden", !showBigCommerceFields);
          bigcommerceFields.setAttribute("aria-hidden", showBigCommerceFields ? "false" : "true");
          bigcommerceInputs.forEach((input) => {
            input.disabled = !showBigCommerceFields;
          });

          const showSquarespaceFields = targetPlatform.value === "squarespace";
          squarespaceFields.classList.toggle("is-hidden", !showSquarespaceFields);
          squarespaceFields.setAttribute("aria-hidden", showSquarespaceFields ? "false" : "true");
          squarespaceInputs.forEach((input) => {
            input.disabled = !showSquarespaceFields;
          });
        };

        targetPlatform.addEventListener("change", syncConditionalFields);
        syncConditionalFields();

        const syncSourceWeightFields = () => {
          if (!sourcePlatform || !sourceWeightFields || !sourceWeightUnit) {
            return;
          }
          const required = sourceWeightRequiredPlatforms.has(sourcePlatform.value);
          sourceWeightFields.classList.toggle("is-hidden", !required);
          sourceWeightFields.setAttribute("aria-hidden", required ? "false" : "true");
          sourceWeightUnit.disabled = !required;
        };
        if (sourcePlatform) {
          sourcePlatform.addEventListener("change", syncSourceWeightFields);
          syncSourceWeightFields();
        }

        const syncPreviewFields = () => {
          if (!previewTargetPlatform || !previewWeightUnit) {
            return;
          }
          const platform = previewTargetPlatform.value;
          const allowedWeightUnits = weightUnitAllowlist[platform] || [];
          const defaultWeightUnit = weightUnitDefaults[platform] || allowedWeightUnits[0] || "kg";
          const currentWeightUnit = previewWeightUnit.value;
          const selectedWeightUnit = allowedWeightUnits.includes(currentWeightUnit)
            ? currentWeightUnit
            : defaultWeightUnit;
          previewWeightUnit.innerHTML = "";
          allowedWeightUnits.forEach((unit) => {
            const option = document.createElement("option");
            option.value = unit;
            option.textContent = unit.toUpperCase();
            if (unit === selectedWeightUnit) {
              option.selected = true;
            }
            previewWeightUnit.appendChild(option);
          });

          const showPreviewBigCommerce = platform === "bigcommerce";
          if (previewBigcommerceFields) {
            previewBigcommerceFields.classList.toggle("is-hidden", !showPreviewBigCommerce);
            previewBigcommerceFields.setAttribute("aria-hidden", showPreviewBigCommerce ? "false" : "true");
            previewBigcommerceInputs.forEach((input) => {
              input.disabled = !showPreviewBigCommerce;
            });
          }

          const showPreviewSquarespace = platform === "squarespace";
          if (previewSquarespaceFields) {
            previewSquarespaceFields.classList.toggle("is-hidden", !showPreviewSquarespace);
            previewSquarespaceFields.setAttribute("aria-hidden", showPreviewSquarespace ? "false" : "true");
            previewSquarespaceInputs.forEach((input) => {
              input.disabled = !showPreviewSquarespace;
            });
          }
        };
        if (previewTargetPlatform) {
          previewTargetPlatform.addEventListener("change", syncPreviewFields);
          syncPreviewFields();
        }
      })();
    </script>
  </body>
</html>
